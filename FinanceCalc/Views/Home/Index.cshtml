@using Microsoft.AspNetCore.Identity
@model FinanceCalc.Models.DashboardViewModel

@{
    ViewData["Title"] = "Home";
    var expenses = Model.Expenses;
    var income = Model.Income;
    var savings = Model.Savings;
}

@if (User.Identity.IsAuthenticated)
{
    <p>
        <a asp-controller="Transactions" asp-action="Create">Create New</a>
    </p>

    <h3 class="mb-4">Overview</h3>

    <div style="display: flex; justify-content: space-around; gap: 2rem; flex-wrap: wrap;">

        <!-- Expenses -->
        <div style="flex: 1; min-width: 250px; max-width: 350px; text-align: center;">
            <h5>Expenses by Category</h5>
            <div id="chartContainer" style="height: 300px; opacity: 0; transform: translateY(20px); transition: all 0.8s ease;">
                <canvas id="expenseChart"></canvas>
            </div>

            <div style="display: flex; justify-content: flex-end; margin-top: 1rem;">
                <button class="btn btn-sm btn-outline-primary" type="button" onclick="toggleFilter('expenseFilter')">Filter</button>
            </div>
            <div id="expenseFilter" style="display:none; margin-top:10px; text-align: left;">
                <div class="d-flex gap-2 mb-2">
                    <input type="date" id="expenseStartDate" class="form-control form-control-sm" />
                    <input type="date" id="expenseEndDate" class="form-control form-control-sm" />
                </div>
                <div>
                    <button class="btn btn-sm btn-primary me-1" onclick="filterExpenses()">Apply</button>
                    <button class="btn btn-sm btn-secondary" onclick="resetExpensesFilter()">Reset</button>
                </div>
            </div>

            <table class="table table-sm mt-3" id="expensesTable">
                <thead>
                    <tr><th>Date</th><th>Amount</th><th>Category</th></tr>
                </thead>
                <tbody>
                    @foreach (var item in expenses)
                    {
                        <tr data-date="@item.Date.ToString("yyyy-MM-dd")">
                            <td>@item.Date.ToShortDateString()</td>
                            <td>@item.Amount.ToString("C")</td>
                            <td>@item.ExpenseCategory</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Income -->
        <div style="flex: 1; min-width: 250px; max-width: 350px; text-align: center;">
            <h5>Monthly Income</h5>
            <div id="incomeChartContainer" style="height: 300px; opacity: 0; transform: translateY(20px); transition: all 0.8s ease;">
                <canvas id="incomeChart"></canvas>
            </div>

            <div style="display: flex; justify-content: flex-end; margin-top: 1rem;">
                <button class="btn btn-sm btn-outline-primary" type="button" onclick="toggleFilter('incomeFilter')">Filter</button>
            </div>
            <div id="incomeFilter" style="display:none; margin-top:10px; text-align: left;">
                <div class="d-flex gap-2 mb-2">
                    <input type="date" id="incomeStartDate" class="form-control form-control-sm" />
                    <input type="date" id="incomeEndDate" class="form-control form-control-sm" />
                </div>
                <div>
                    <button class="btn btn-sm btn-primary me-1" onclick="filterIncome()">Apply</button>
                    <button class="btn btn-sm btn-secondary" onclick="resetIncomeFilter()">Reset</button>
                </div>
            </div>

            <table class="table table-sm mt-3" id="incomeTable">
                <thead>
                    <tr><th>Date</th><th>Amount</th></tr>
                </thead>
                <tbody>
                    @foreach (var item in income)
                    {
                        <tr data-date="@item.Date.ToString("yyyy-MM-dd")">
                            <td>@item.Date.ToShortDateString()</td>
                            <td>@item.Amount.ToString("C")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Savings -->
        <div style="flex: 1; min-width: 250px; max-width: 350px; text-align: center;">
            <h5>Savings</h5>
            <div id="savingsChartContainer" style="height: 300px; opacity: 0; transform: translateY(20px); transition: all 0.8s ease;">
                <canvas id="savingsChart"></canvas>
            </div>

            <div style="display: flex; justify-content: flex-end; margin-top: 1rem;">
                <button class="btn btn-sm btn-outline-primary" type="button" onclick="toggleFilter('savingsFilter')">Filter</button>
            </div>
            <div id="savingsFilter" style="display:none; margin-top:10px; text-align: left;">
                <div class="d-flex gap-2 mb-2">
                    <input type="date" id="savingsStartDate" class="form-control form-control-sm" />
                    <input type="date" id="savingsEndDate" class="form-control form-control-sm" />
                </div>
                <div>
                    <button class="btn btn-sm btn-primary me-1" onclick="filterSavings()">Apply</button>
                    <button class="btn btn-sm btn-secondary" onclick="resetSavingsFilter()">Reset</button>
                </div>
            </div>

            <table class="table table-sm mt-3" id="savingsTable">
                <thead>
                    <tr><th>Date</th><th>Amount</th></tr>
                </thead>
                <tbody>
                    @foreach (var item in savings)
                    {
                        <tr data-date="@item.Date.ToString("yyyy-MM-dd")">
                            <td>@item.Date.ToShortDateString()</td>
                            <td>@item.Amount.ToString("C")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- All Transactions unchanged here -->
    <h4 class="mt-5">All Transactions</h4>
    <table class="table mt-3">
        <thead>
            <tr>
                <th>@Html.DisplayNameFor(model => model.AllTransactions.First().Date)</th>
                <th>@Html.DisplayNameFor(model => model.AllTransactions.First().Amount)</th>
                <th>@Html.DisplayNameFor(model => model.AllTransactions.First().ExpenseCategory)</th>
                <th>@Html.DisplayNameFor(model => model.AllTransactions.First().Type)</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model.AllTransactions)
            {
                <tr>
                    <td>@item.Date.ToShortDateString()</td>
                    <td>@item.Amount.ToString("C")</td>
                    <td>@item.ExpenseCategory</td>
                    <td>@item.Type</td>
                    <td>
                        <a asp-controller="Transactions" asp-action="Edit" asp-route-id="@item.Id">Edit</a> |
                        <a asp-controller="Transactions" asp-action="Details" asp-route-id="@item.Id">Details</a> |
                        <a asp-controller="Transactions" asp-action="Delete" asp-route-id="@item.Id">Delete</a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <p>Please explore our app and consider signing up to track your expenses!</p>
}

@section Scripts {
    @if (User.Identity.IsAuthenticated)
    {
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const fadeIn = (id) => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.style.opacity = '1';
                        el.style.transform = 'translateY(0)';
                    }
                };

                fadeIn("chartContainer");
                fadeIn("incomeChartContainer");
                fadeIn("savingsChartContainer");

                // Expenses Chart
                const expenseCtx = document.getElementById('expenseChart').getContext('2d');
                new Chart(expenseCtx, {
                    type: 'doughnut',
                    data: {
                        labels: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.Labels)),
                        datasets: [{
                            label: 'Expenses by Category',
                            data: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.Data)),
                            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'],
                            hoverOffset: 10
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            animateScale: true,
                            animateRotate: true,
                            duration: 1200,
                            easing: 'easeOutBounce'
                        },
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });

                // Income Chart
                const incomeAmount = @ViewBag.MonthlyIncome ?? 0;
                const incomeCtx = document.getElementById('incomeChart').getContext('2d');
                new Chart(incomeCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Income'],
                        datasets: [{
                            data: [incomeAmount],
                            backgroundColor: ['#28a745'],
                            hoverOffset: 10
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });

                // Savings Chart
                const savingsAmount = @ViewBag.Savings ?? 0;
                const savingsCtx = document.getElementById('savingsChart').getContext('2d');
                new Chart(savingsCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Savings'],
                        datasets: [{
                            data: [savingsAmount],
                            backgroundColor: ['#17a2b8'],
                            hoverOffset: 10
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            });

            // Toggle filter visibility
            function toggleFilter(filterId) {
                const filterDiv = document.getElementById(filterId);
                if (filterDiv.style.display === "none" || filterDiv.style.display === "") {
                    filterDiv.style.display = "block";
                } else {
                    filterDiv.style.display = "none";
                }
            }

            // Filter functions for each section

            function filterTableByDate(tableId, startDateId, endDateId) {
                const startDateInput = document.getElementById(startDateId);
                const endDateInput = document.getElementById(endDateId);
                const table = document.getElementById(tableId);
                const startDate = startDateInput.value ? new Date(startDateInput.value) : null;
                const endDate = endDateInput.value ? new Date(endDateInput.value) : null;

                Array.from(table.tBodies[0].rows).forEach(row => {
                    const rowDateStr = row.getAttribute('data-date');
                    if (!rowDateStr) {
                        row.style.display = "";
                        return;
                    }
                    const rowDate = new Date(rowDateStr);

                    if ((startDate && rowDate < startDate) || (endDate && rowDate > endDate)) {
                        row.style.display = "none";
                    } else {
                        row.style.display = "";
                    }
                });
            }

            function filterExpenses() {
                filterTableByDate("expensesTable", "expenseStartDate", "expenseEndDate");
            }

            function resetExpensesFilter() {
                document.getElementById("expenseStartDate").value = "";
                document.getElementById("expenseEndDate").value = "";
                filterExpenses();
            }

            function filterIncome() {
                filterTableByDate("incomeTable", "incomeStartDate", "incomeEndDate");
            }

            function resetIncomeFilter() {
                document.getElementById("incomeStartDate").value = "";
                document.getElementById("incomeEndDate").value = "";
                filterIncome();
            }

            function filterSavings() {
                filterTableByDate("savingsTable", "savingsStartDate", "savingsEndDate");
            }

            function resetSavingsFilter() {
                document.getElementById("savingsStartDate").value = "";
                document.getElementById("savingsEndDate").value = "";
                filterSavings();
            }
        </script>
    }
}
